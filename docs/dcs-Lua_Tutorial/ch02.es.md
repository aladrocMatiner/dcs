# Cap√≠tulo 02 ‚Äî Pipeline, configuraci√≥n y librer√≠as comunes de Lua en DCS (VS Code)

üá¨üáß [English](ch02.md) | üá™üá∏ **Espa√±ol** | üá∏üá™ [Svenska](ch02.sv.md) | üá´üáÆ [Suomi](ch02.fi.md)

Volver al √≠ndice: [README.es.md](README.es.md)

## Objetivo

Montar un workflow (‚Äúpipeline‚Äù) pr√°ctico para trabajar c√≥modo con scripting de misiones en DCS usando **Visual Studio Code**, y entender las librer√≠as/ecosistemas m√°s habituales de Lua en DCS.

Este cap√≠tulo sigue siendo **nivel principiante**. El resultado principal es: ‚Äús√© c√≥mo voy a trabajar‚Äù y ‚Äús√© comprobar en DCS que mi script est√° corriendo‚Äù.

## Objetivos del cap√≠tulo

- Entender d√≥nde se ejecuta Lua en DCS (MSE) y desde qu√© acciones se lanza.
- Montar un pipeline estable: escribir ‚Üí meter en la misi√≥n ‚Üí ejecutar ‚Üí observar ‚Üí iterar.
- Saber ‚Äúver resultados‚Äù sin depender de `print` (pantalla + logs).
- Empezar con una estructura de script limpia: `local` + un solo namespace para tu misi√≥n.
- Salir con un mini‚Äëlab aplicable en una misi√≥n real (sin frameworks).

## √çndice r√°pido

- [Aplicado a DCS (lo m√≠nimo imprescindible)](#aplicado-a-dcs)
- [Pipeline (autor ‚Üí empaquetar ‚Üí ejecutar ‚Üí observar ‚Üí iterar)](#pipeline)
- [DO SCRIPT vs DO SCRIPT FILE (qu√© usar y cu√°ndo)](#do-script-vs-do-script-file)
- [Ver resultados: pantalla y logs](#ver-resultados)
- [Estructura recomendada: `local` + namespace](#namespace)
- [VS Code (setup r√°pido)](#vscode)
- [API de DCS vs librer√≠as de la comunidad](#api-vs-libs)
- [Mini‚Äëlab (20‚Äì30 min)](#mini-lab)
- [Checklist: ‚Äúmi pipeline est√° listo‚Äù](#checklist)

<a id="aplicado-a-dcs"></a>
## Aplicado a DCS (lo m√≠nimo imprescindible)

En DCS, el scripting de misi√≥n corre en el **Mission Scripting Environment (MSE)**: la ‚Äúcapa‚Äù donde vive la l√≥gica de la misi√≥n (eventos, unidades, acciones, estado).

¬øC√≥mo lo ejecutas normalmente?
- **Triggers** del Mission Editor: `DO SCRIPT` / `DO SCRIPT FILE` (lo m√°s com√∫n).
- **AI Tasking**: acciones tipo *Script* / *Script File* (√∫til para ejecutar l√≥gica ‚Äúcomo tarea‚Äù de una unidad).
- **Initialization script**: l√≥gica que se ejecuta muy pronto (antes de que spawneen unidades y antes del primer trigger), seg√∫n el tipo de misi√≥n/servidor.

Nota importante: por **seguridad**, el entorno suele estar ‚Äúsanitizado‚Äù; algunas librer√≠as est√°ndar de Lua (como `io`, `os`, `lfs`) pueden estar deshabilitadas o restringidas. T√≥malo como una advertencia: dise√±a tu misi√≥n para funcionar sin depender de I/O externo.

<a id="pipeline"></a>
## El pipeline (autor ‚Üí empaquetar ‚Üí ejecutar ‚Üí observar ‚Üí iterar)

Piensa en el scripting como un bucle:

1. **Autor√≠a**: escribir/editar en VS Code (feedback r√°pido, b√∫squeda, control de versiones).
2. **Empaquetado**: incluir scripts (y librer√≠as) en la misi√≥n que vas a ejecutar.
3. **Ejecuci√≥n**: lanzar la misi√≥n en DCS.
4. **Observaci√≥n**: confirmar que los cambios se notan (mensajes, comportamiento, logs).
5. **Iteraci√≥n**: ajustar una cosa cada vez hasta que haga lo que quieres.

El error t√≠pico es intentar ‚Äúterminar toda la l√≥gica‚Äù antes de tener un bucle fiable. Primero construye el bucle.

Aplicado a DCS (m√≠nimo viable):
- Crea un trigger *MISSION START* con `DO SCRIPT` y un `trigger.action.outText(...)` para verificar ejecuci√≥n.
- En cuanto funcione, p√°salo a `DO SCRIPT FILE` y ed√≠talo desde VS Code.

<a id="do-script-vs-do-script-file"></a>
## DO SCRIPT vs DO SCRIPT FILE (qu√© usar y cu√°ndo)

En el Mission Editor, ambos ejecutan Lua, pero sirven para cosas distintas:

- `DO SCRIPT`: para pruebas r√°pidas o scripts cortos. √ötil para validar una idea (‚Äú¬øse ejecuta?‚Äù) sin gestionar archivos.
- `DO SCRIPT FILE`: para trabajo real. Te deja versionar, editar en VS Code, reutilizar y mantener scripts sin copiar/pegar.

Aplicado a DCS:
- Para un proyecto serio, usa **un `DO SCRIPT FILE` en *Mission Start*** que cargue tu ‚Äún√∫cleo‚Äù (handlers, men√∫s, estado).
- Usa `DO SCRIPT` solo como ‚Äúsonda‚Äù o para cambios muy peque√±os mientras iteras.

<a id="ver-resultados"></a>
## Ver resultados: pantalla y logs

En DCS, ‚Äúver‚Äù resultados r√°pido es clave. `print()` a menudo no es lo m√°s √∫til; prioriza **feedback visible** y **logs**.

### Ejemplo 1 ‚Äî feedback visual en misi√≥n (pantalla)

√ösalo para confirmar que el trigger realmente se dispar√≥ y que tu script corre.

D√≥nde pegarlo: Mission Editor ‚Üí *Triggers* ‚Üí (por ejemplo *MISSION START*) ‚Üí `DO SCRIPT`.

```lua
trigger.action.outText("Lua OK: script ejecutado", 10)
```

### Ejemplo 2 ‚Äî logs para depurar (dcs.log)

√ösalo para dejar ‚Äúhuellas‚Äù cuando el resultado no es visible (o para trazar estados).

D√≥nde pegarlo: Mission Editor ‚Üí *Triggers* ‚Üí (por ejemplo *MISSION START*) ‚Üí `DO SCRIPT` o dentro de tu archivo `DO SCRIPT FILE`.

```lua
env.info("[MyMission] init: script loaded")
```

D√≥nde se ve: en el archivo `dcs.log` (normalmente bajo `Saved Games\\DCS\\Logs\\dcs.log`; en servidor dedicado, en los logs del servidor).

<a id="namespace"></a>
## Estructura recomendada: `local` + namespace (sin globales sueltas)

En misiones reales vas a tener varias funciones, estado y callbacks (men√∫s F10, handlers de eventos). Si dejas variables globales ‚Äúsueltas‚Äù, acabas con colisiones, confusi√≥n y resets inesperados.

Patr√≥n recomendado (principiante y pr√°ctico): **un √∫nico namespace global** (por ejemplo `MyMission`) y el resto `local`.

D√≥nde pegarlo: idealmente en un archivo y cargarlo con `DO SCRIPT FILE` en *Mission Start*.

```lua
MyMission = MyMission or {}
local M = MyMission

M.state = M.state or { kills = 0 }

local function say(text)
  trigger.action.outText(text, 10)
end

function M.init()
  say("MyMission listo")
  env.info("[MyMission] init")
end

M.init()
```

Aplicado a DCS:
- Si luego quieres que otros triggers llamen cosas, puedes hacer `DO SCRIPT` con `MyMission.init()` o `MyMission.state...`.
- Si no necesitas ‚ÄúAPI p√∫blica‚Äù, mant√©n casi todo `local` y exp√≥n solo 2‚Äì3 funciones en `MyMission`.

## Qu√© hay que ‚Äúinstalar‚Äù (y qu√© no)

### Para ejecutar Lua en DCS

Normalmente **no** necesitas instalar Lua para *ejecutar* scripts en DCS.

DCS ejecuta el scripting de misi√≥n con su propio runtime de Lua integrado cuando usas triggers del Editor de Misiones (por ejemplo `DO SCRIPT` / `DO SCRIPT FILE`).

### Para trabajar c√≥modo (tooling local opcional)

El tooling local es para **escribir mejor**, no para ejecutar dentro de DCS:

- **VS Code + language server de Lua**: diagn√≥sticos, autocompletado, navegaci√≥n.
- **Formateador** (opcional): estilo consistente para que los diffs sean legibles.
- **Int√©rprete de Lua** (opcional): peque√±as pruebas offline.

Si instalas Lua localmente, √∫salo como ‚Äúmodo pr√°ctica‚Äù. DCS sigue ejecutando en su propio entorno, as√≠ que verifica siempre en el juego.

<a id="vscode"></a>
## Setup de VS Code (pr√°ctico)

### 1) Instala una extensi√≥n de Lua / language server

En VS Code (o VSCodium como alternativa libre), busca una extensi√≥n que ofrezca:

- Resaltado de sintaxis
- Diagn√≥sticos
- Autocompletado (funcionalidad de language server)

Busca soporte de ‚ÄúLua Language Server‚Äù. Hay varias opciones; lo importante es que tenga language server.

Recomendaci√≥n (la opci√≥n m√°s usada): instala **‚ÄúLua‚Äù** basada en **Lua Language Server** (servidor `sumneko.lua`). M√°s info en https://marketplace.visualstudio.com/items?itemName=sumneko.lua.

### 1b) Instalar el editor (Windows/Linux/Mac)

Antes de cargar scripts, aseg√∫rate de tener instalado VS Code o VSCodium:

- **Windows**: descarga el instalador `.exe` de https://code.visualstudio.com o el MSI de https://vscodium.com y sigue el asistente.
- **Linux**: usa el paquete `.deb`/`.rpm` que prefieras o instala desde tu gestor (`sudo snap install code --classic`, `sudo apt install codium`, etc.).
- **Mac**: descarga el `.zip`/`.dmg` de cada sitio, descomprime y mueve la app a `/Applications`.

VSCodium es la alternativa libre (sin telemetr√≠a) y posee los mismos paquetes; simplemente usa sus assets en lugar de los de Microsoft.

### 2) Elige una estructura de carpetas simple

Ejemplo:

- `scripts/` ‚Äî tu c√≥digo de misi√≥n
- `libs/` ‚Äî librer√≠as de terceros (MIST/MOOSE/etc.)
- `missions/` ‚Äî la `.miz` que ejecutas (o notas de qu√© misi√≥n editas)
- `notes/` ‚Äî notas, TODOs, checklists

La misi√≥n es tu ‚Äúcontenedor de runtime‚Äù; la carpeta es tu ‚Äúfuente de verdad‚Äù.

### 3) Estrategia de formato (aburrida y consistente)

Elige un estilo de indentaci√≥n y mant√©nlo. El objetivo no es ‚Äúbonito‚Äù, es:

- Diffs claros
- Menos errores ‚Äúinvisibles‚Äù
- Mejor colaboraci√≥n

Si usas un formateador, intenta no mezclar ‚Äúsolo formato‚Äù con cambios de l√≥gica en el mismo commit/edici√≥n.

Aplicado a DCS (recomendaci√≥n simple):
- Trata tu carpeta `scripts/` como ‚Äúfuente de verdad‚Äù.
- En la misi√≥n, usa `DO SCRIPT FILE` apuntando a un archivo (por ejemplo `scripts/my_mission.lua`) incluido en la `.miz`.

<a id="api-vs-libs"></a>
## API de DCS vs librer√≠as de la comunidad

Hay dos ‚Äúmundos‚Äù:

### DCS: scripting integrado

Es el entorno que existe dentro de las misiones y aporta los bloques b√°sicos:

- Eventos (cosas que pasan)
- Timers / chequeos peri√≥dicos
- Mensajer√≠a
- Acceso a objetos de misi√≥n (unidades, grupos, coaliciones, zonas) seg√∫n lo que exponga DCS

### Librer√≠as / frameworks de la comunidad

Paquetes Lua de terceros para no reescribir patrones comunes y construir l√≥gica compleja m√°s r√°pido.

Suelen aportar:

- Abstracciones de m√°s alto nivel (tasking, spawning, gesti√≥n de IA)
- Utilidades (buscar unidades, estado, scheduling)
- Sistemas reutilizables (log√≠stica, IADS, scoring)

## Librer√≠as/frameworks comunes en DCS (visi√≥n conceptual)

### MIST (Mission Scripting Tools)

Suele usarse como capa de utilidades:

- Funciones √∫tiles y patrones comunes
- √ötil si quieres estar cerca de ‚ÄúLua normal‚Äù sin tanto boilerplate

### MOOSE (Mission Object Oriented Scripting Environment)

M√°s orientado a framework:

- Ayuda a estructurar misiones grandes con muchas piezas
- √ötil si quieres conceptos de alto nivel y l√≥gica reutilizable

### Otros add-ons (categor√≠as)

Seg√∫n el tipo de misi√≥n, ver√°s:

- **Sistemas IADS** (defensa a√©rea integrada)
- **Log√≠stica / transporte de tropas**
- **Herramientas de admin** para multiplayer (mensajes, utilidades)

√ösalos cuando tu pipeline sea estable.

## Cu√°ndo usar triggers vs Lua vs librer√≠as

Heur√≠stica:

- Comportamiento simple/est√°tico: **triggers del Editor** suelen bastar.
- Flujo din√°mico, estado, bifurcaciones, chequeos repetidos: **Lua** ayuda.
- Escenario complejo con muchos sistemas: **librer√≠as/frameworks** ahorran tiempo, pero a√±aden dependencias y mantenimiento.

<a id="mini-lab"></a>
## Mini‚Äëlab (20‚Äì30 min): ‚ÄúHello + Debug + F10‚Äù

Objetivo: salir con una misi√≥n donde confirmas ejecuci√≥n por pantalla y por log, y tienes un ‚Äúbot√≥n‚Äù F10 para comprobar estado.

1) Crea una misi√≥n simple en el Mission Editor (un avi√≥n jugador en pista basta).
2) Crea un archivo `my_mission.lua` (en tu repo/carpeta de trabajo).
3) Dentro de `my_mission.lua`, usa el patr√≥n de namespace `MyMission` del apartado anterior y a√±ade:
   - Un `trigger.action.outText("Lua OK...", 10)` al init.
   - Un `env.info("[MyMission] ...")` al init.
   - Un men√∫ F10 con un comando ‚ÄúEstado‚Äù.
4) En el Mission Editor: *Triggers* ‚Üí *MISSION START* ‚Üí `DO SCRIPT FILE` y selecciona tu `my_mission.lua` (incluido en la `.miz`).
5) Ejecuta la misi√≥n y confirma los resultados.

Snippet m√≠nimo (ponlo dentro de `M.init()` en tu `my_mission.lua`):

```lua
local menu = missionCommands.addSubMenu("Entrenamiento")
missionCommands.addCommand("Estado", menu, function()
  trigger.action.outText("Kills: " .. M.state.kills, 5)
end)
```

Checklist (en juego / en logs):
- En pantalla ves ‚ÄúLua OK‚Ä¶‚Äù al empezar la misi√≥n.
- En `dcs.log` aparece una l√≠nea con `[MyMission] init`.
- En F10 aparece tu men√∫ y el comando ‚ÄúEstado‚Äù muestra un texto (aunque sea b√°sico).

Si esto funciona, tu pipeline ya est√° ‚Äúvivo‚Äù: ya puedes empezar a a√±adir l√≥gica real (handlers, timers, activaci√≥n de grupos) sin ir a ciegas.

<a id="checklist"></a>
## Checklist: ‚Äúmi pipeline est√° listo‚Äù

- [ ] Tengo VS Code instalado y una extensi√≥n con Lua language server activa.
- [ ] Tengo estructura de carpetas (`scripts/`, `libs/`, etc.) y encuentro r√°pido los archivos.
- [ ] S√© c√≥mo voy a incluir scripts en una misi√≥n (`DO SCRIPT` / `DO SCRIPT FILE`).
- [ ] Tengo un plan para verificar cambios (mensajes/logs/comportamiento observable).
- [ ] S√© qu√© quiero explorar despu√©s (Lua ‚Äúvanilla‚Äù, MIST, o MOOSE).

## Siguiente

En el pr√≥ximo cap√≠tulo escribiremos los scripts m√≠nimos √∫tiles y construiremos un bucle fiable de ‚Äúcambio ‚Üí ejecutar ‚Üí verificar‚Äù con el m√≠nimo de c√≥digo.

## Navegaci√≥n

Anterior: [Cap√≠tulo 01](ch01.es.md)
